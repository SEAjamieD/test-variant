name: "Test"
run-name: "Test token"


on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  check-token:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Code Checkout
        run: |
          echo "hello"
          export MY_TOKEN=$(curl -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=vjtest" | jq -r '.value')
          # echo $MY_TOKEN
          # export MONDOO_CONFIG_BASE64=$(curl --request POST --url 'https://2cb4-24-25-215-252.ngrok-free.app/SecureTokenService/ExchangeExternalToken' --header 'content-type: application/json' --data '{"audience": "//captain.api.mondoo.app/spaces/test-infallible-taussig-796596","issuer_uri": "https://token.actions.githubusercontent.com","jwt_token": "'"${MY_TOKEN}"'"}' | jq -r '.base64_credential')
          export MONDOO_CONFIG_BASE64=eyJtcm4iOiIvL2FnZW50cy5hcGkubW9uZG9vLmFwcC9zcGFjZXMvdGVzdC1pbmZhbGxpYmxlLXRhdXNzaWctNzk2NTk2L3NlcnZpY2VhY2NvdW50cy8ydHNCSFFweTJmRlpJdHIxWUh5S2VEemZKajEiLCJzcGFjZV9tcm4iOiIvL2NhcHRhaW4uYXBpLm1vbmRvby5hcHAvc3BhY2VzL3Rlc3QtaW5mYWxsaWJsZS10YXVzc2lnLTc5NjU5NiIsInByaXZhdGVfa2V5IjoiLS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tXG5NSUcyQWdFQU1CQUdCeXFHU000OUFnRUdCU3VCQkFBaUJJR2VNSUdiQWdFQkJERHZoQ1l2MVVxV2xxWTdBckZ4XG40L0tDZG10NGxjWk5MR0doU0UzaytxRDY3dWI1YlBUYjM1eVhsd2swR09FRnVHZWhaQU5pQUFRWXIxbmNDRDZoXG44a2hYeEhTMWNhQy90MUROLzY1NkZZVFVtdlg5OG1WSDV0VThoYVp3anpTOFpGUXM0N2tSeGN5b3VSZ3dGaHR4XG5DcGxvelVJOW01eVBGSlE3TW5PYXM5Qk84TzV2TjZJMHIyaFp0K0JlZ3JUZEVrcEVuQ1lHWUFFPVxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwiY2VydGlmaWNhdGUiOiItLS0tLUJFR0lOIENFUlRJRklDQVRFLS0tLS1cbk1JSUNrVENDQWhlZ0F3SUJBZ0lRRWd0RUdzbkFUMzd3dUZUL0dmZzhIekFLQmdncWhrak9QUVFEQXpCSk1VY3dcblJRWURWUVFLRXo0dkwyTmhjSFJoYVc0dVlYQnBMbTF2Ym1SdmJ5NWhjSEF2YzNCaFkyVnpMM1JsYzNRdGFXNW1cbllXeHNhV0pzWlMxMFlYVnpjMmxuTFRjNU5qVTVOakFnRncweU5UQXpNRFF5TXpJMk5UTmFHQTg1T1RrNU1USXpcbk1USXpOVGsxT1Zvd1NURkhNRVVHQTFVRUNoTStMeTlqWVhCMFlXbHVMbUZ3YVM1dGIyNWtiMjh1WVhCd0wzTndcbllXTmxjeTkwWlhOMExXbHVabUZzYkdsaWJHVXRkR0YxYzNOcFp5MDNPVFkxT1RZd2RqQVFCZ2NxaGtqT1BRSUJcbkJnVXJnUVFBSWdOaUFBUVlyMW5jQ0Q2aDhraFh4SFMxY2FDL3QxRE4vNjU2RllUVW12WDk4bVZINXRVOGhhWndcbmp6UzhaRlFzNDdrUnhjeW91Umd3Rmh0eENwbG96VUk5bTV5UEZKUTdNbk9hczlCTzhPNXZONkkwcjJoWnQrQmVcbmdyVGRFa3BFbkNZR1lBR2pnY0V3Z2I0d0RnWURWUjBQQVFIL0JBUURBZ1dnTUJNR0ExVWRKUVFNTUFvR0NDc0dcbkFRVUZCd01CTUF3R0ExVWRFd0VCL3dRQ01BQXdkQVlEVlIwUkJHMHdhNEpwTHk5aFoyVnVkSE11WVhCcExtMXZcbmJtUnZieTVoY0hBdmMzQmhZMlZ6TDNSbGMzUXRhVzVtWVd4c2FXSnNaUzEwWVhWemMybG5MVGM1TmpVNU5pOXpcblpYSjJhV05sWVdOamIzVnVkSE12TW5SelFraFJjSGt5WmtaYVNYUnlNVmxJZVV0bFJIcG1TbW94TUJNR0ExVWRcbkpnUU1EQXAyWlhKemFXOXVPbll5TUFvR0NDcUdTTTQ5QkFNREEyZ0FNR1VDTUZndC8yNjVySUo3QWdpcC96VHFcblRmZGhNa2g1c2Fab0RVWHZKanVSNXRjbWh4cGN2NHZzTyt2ZEFXKzhkRDZJUFFJeEFLTWNZL3A2a1pVMHJVL0hcbmgxZVdsd3c0M1hBM0xvUFlualQ4aCt0bHdDNjNWZDZwZ2ZvYUkzbmtuRTVUWUJSeGJRPT1cbi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS1cbiIsImFwaV9lbmRwb2ludCI6Imh0dHA6Ly8xMjcuMC4wLjE6ODk4OSJ9
          bash -c "$(curl -sSL https://install.mondoo.com/sh)"
          cnspec status
          # if [ $(echo $?) != 0 ]; then echo "failed to reach mondoo" exit 1; fi

          cnspec scan
