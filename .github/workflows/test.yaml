name: "Test"
run-name: "Test token"


on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  check-token:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Code Checkout
        run: |
          echo "hello"
          export MY_TOKEN=$(curl -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=vjtest" | jq -r '.value')
          # echo $MY_TOKEN
          # export MONDOO_CONFIG_BASE64=$(curl --request POST --url 'https://2cb4-24-25-215-252.ngrok-free.app/SecureTokenService/ExchangeExternalToken' --header 'content-type: application/json' --data '{"audience": "//captain.api.mondoo.app/spaces/test-infallible-taussig-796596","issuer_uri": "https://token.actions.githubusercontent.com","jwt_token": "'"${MY_TOKEN}"'"}' | jq -r '.base64_credential')
          export MONDOO_CONFIG_BASE64=eyJtcm4iOiIvL2FnZW50cy5hcGkubW9uZG9vLmFwcC9zcGFjZXMvdGVzdC1pbmZhbGxpYmxlLXRhdXNzaWctNzk2NTk2L3NlcnZpY2VhY2NvdW50cy8ydHM5THpsTjFCMUVGUFVNZmREYm5aSG51b3IiLCJjZXJ0aWZpY2F0ZSI6Ii0tLS0tQkVHSU4gQ0VSVElGSUNBVEUtLS0tLVxuTUlJQ2tUQ0NBaGVnQXdJQkFnSVFkd2RYS21yeVBpODFmQXBUci9zRjdqQUtCZ2dxaGtqT1BRUURBekJKTVVjd1xuUlFZRFZRUUtFejR2TDJOaGNIUmhhVzR1WVhCcExtMXZibVJ2Ynk1aGNIQXZjM0JoWTJWekwzUmxjM1F0YVc1bVxuWVd4c2FXSnNaUzEwWVhWemMybG5MVGM1TmpVNU5qQWdGdzB5TlRBek1EUXlNekV4TURKYUdBODVPVGs1TVRJelxuTVRJek5UazFPVm93U1RGSE1FVUdBMVVFQ2hNK0x5OWpZWEIwWVdsdUxtRndhUzV0YjI1a2IyOHVZWEJ3TDNOd1xuWVdObGN5OTBaWE4wTFdsdVptRnNiR2xpYkdVdGRHRjFjM05wWnkwM09UWTFPVFl3ZGpBUUJnY3Foa2pPUFFJQlxuQmdVcmdRUUFJZ05pQUFTVEFUMFVsWkpvV3E5OXNJQjNHb25hZnE1a2wvaWlpbDYzbU9tekNLa0FHbXRFLzdsZVxuVmhvT2R5NFR1SmtEL280clhOSFNyZnBseFQ0aFNKQkhGVDNkTmgyV01CNVRLdmtRNHhaYnJuVHRZYThKSTBPSlxuMVowMGZRU2hjV25mK2kramdjRXdnYjR3RGdZRFZSMFBBUUgvQkFRREFnV2dNQk1HQTFVZEpRUU1NQW9HQ0NzR1xuQVFVRkJ3TUJNQXdHQTFVZEV3RUIvd1FDTUFBd2RBWURWUjBSQkcwd2E0SnBMeTloWjJWdWRITXVZWEJwTG0xdlxuYm1SdmJ5NWhjSEF2YzNCaFkyVnpMM1JsYzNRdGFXNW1ZV3hzYVdKc1pTMTBZWFZ6YzJsbkxUYzVOalU1Tmk5elxuWlhKMmFXTmxZV05qYjNWdWRITXZNblJ6T1V4NmJFNHhRakZGUmxCVlRXWmtSR0p1V2todWRXOXlNQk1HQTFVZFxuSmdRTURBcDJaWEp6YVc5dU9uWXlNQW9HQ0NxR1NNNDlCQU1EQTJnQU1HVUNNUUM1Q3pQcGd6VzRkRGExV3dpQVxuRkRnbTFHTURZd213b1hiMHRBOWNtUERUVGl2SXVpZTFoU2NyWXRZTjVZSXU3aW9DTUVxMlpIYzZSWFk1WjNkYlxueWtVYTVweXlCOEpxN3pJbk95M3ViUy9KeG1PYUd6MlIybTNCc01JSkFuWEZCczJWMnc9PVxuLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLVxuIiwicHJpdmF0ZV9rZXkiOiItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JRzJBZ0VBTUJBR0J5cUdTTTQ5QWdFR0JTdUJCQUFpQklHZU1JR2JBZ0VCQkRDblNaT2h5R3ZLNUlCdGNmVU1cbmZSelgwMk5Qa3hlaEhlaktYQ2lUVkFuOS9paHBpMWx3dlVueFZLYmdQMXJHUjV5aFpBTmlBQVNUQVQwVWxaSm9cbldxOTlzSUIzR29uYWZxNWtsL2lpaWw2M21PbXpDS2tBR210RS83bGVWaG9PZHk0VHVKa0QvbzRyWE5IU3JmcGxcbnhUNGhTSkJIRlQzZE5oMldNQjVUS3ZrUTR4WmJyblR0WWE4SkkwT0oxWjAwZlFTaGNXbmYraTg9XG4tLS0tLUVORCBQUklWQVRFIEtFWS0tLS0tXG4iLCJzY29wZV9tcm4iOiIvL2NhcHRhaW4uYXBpLm1vbmRvby5hcHAvc3BhY2VzL3Rlc3QtaW5mYWxsaWJsZS10YXVzc2lnLTc5NjU5NiIsImFwaV9lbmRwb2ludCI6Imh0dHA6Ly8xMjcuMC4wLjE6ODk4OSIsInNwYWNlX21ybiI6Ii8vY2FwdGFpbi5hcGkubW9uZG9vLmFwcC9zcGFjZXMvdGVzdC1pbmZhbGxpYmxlLXRhdXNzaWctNzk2NTk2IiwidHlwZW5hbWUiOiJTZXJ2aWNlQWNjb3VudENyZWRlbnRpYWwifQ==
          bash -c "$(curl -sSL https://install.mondoo.com/sh)"
          cnspec status
          # if [ $(echo $?) != 0 ]; then echo "failed to reach mondoo" exit 1; fi

          cnspec scan
