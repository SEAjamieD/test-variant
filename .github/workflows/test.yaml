name: "Test"
run-name: "Test token"


on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  check-token:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Code Checkout
        run: |
          echo "hello"
          export MY_TOKEN=$(curl -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=vjtest" | jq -r '.value')
          # echo $MY_TOKEN
          # export MONDOO_CONFIG_BASE64=$(curl --request POST --url 'https://2cb4-24-25-215-252.ngrok-free.app/SecureTokenService/ExchangeExternalToken' --header 'content-type: application/json' --data '{"audience": "//captain.api.mondoo.app/spaces/test-infallible-taussig-796596","issuer_uri": "https://token.actions.githubusercontent.com","jwt_token": "'"${MY_TOKEN}"'"}' | jq -r '.base64_credential')
          export MONDOO_CONFIG_BASE64=eyJtcm4iOiIvL2FnZW50cy5hcGkubW9uZG9vLmFwcC9zcGFjZXMvdGVzdC1pbmZhbGxpYmxlLXRhdXNzaWctNzk2NTk2L3NlcnZpY2VhY2NvdW50cy8ydHM5aVAwdE54UWxZa2lCSWRpc052Y0NKV2giLCJzcGFjZV9tcm4iOiIvL2NhcHRhaW4uYXBpLm1vbmRvby5hcHAvc3BhY2VzL3Rlc3QtaW5mYWxsaWJsZS10YXVzc2lnLTc5NjU5NiIsInByaXZhdGVfa2V5IjoiLS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tXG5NSUcyQWdFQU1CQUdCeXFHU000OUFnRUdCU3VCQkFBaUJJR2VNSUdiQWdFQkJEQ29UMCtmeVljcnlHbTNWNWNhXG5YbWVxUDllR3psL3E1K1NoVmdUSEFGN0lCUHFQV3Fmeno3aUVqZFFFeEtUbUNzNmhaQU5pQUFTMThqQWxyY0U3XG5OeWxhZjk1TnF1M3BoUmhRYzNVcEZOSDI0ZVExOUFHYllNZXVmMGRtcmV2cjF0WmhGTU1pa0h2cld4bCtLcjRXXG50ZTFROWp4ckdYRmZRbnhHdWphVkdCT041RnNjM1BBa3JzbU5jKzRtd3Q0NnNETXhBb1NVK3ZJPVxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwiY2VydGlmaWNhdGUiOiItLS0tLUJFR0lOIENFUlRJRklDQVRFLS0tLS1cbk1JSUNrVENDQWhlZ0F3SUJBZ0lRSURHTXhpN0pGbTdZYVhxMGtCbkNXVEFLQmdncWhrak9QUVFEQXpCSk1VY3dcblJRWURWUVFLRXo0dkwyTmhjSFJoYVc0dVlYQnBMbTF2Ym1SdmJ5NWhjSEF2YzNCaFkyVnpMM1JsYzNRdGFXNW1cbllXeHNhV0pzWlMxMFlYVnpjMmxuTFRjNU5qVTVOakFnRncweU5UQXpNRFF5TXpFME1ERmFHQTg1T1RrNU1USXpcbk1USXpOVGsxT1Zvd1NURkhNRVVHQTFVRUNoTStMeTlqWVhCMFlXbHVMbUZ3YVM1dGIyNWtiMjh1WVhCd0wzTndcbllXTmxjeTkwWlhOMExXbHVabUZzYkdsaWJHVXRkR0YxYzNOcFp5MDNPVFkxT1RZd2RqQVFCZ2NxaGtqT1BRSUJcbkJnVXJnUVFBSWdOaUFBUzE4akFscmNFN055bGFmOTVOcXUzcGhSaFFjM1VwRk5IMjRlUTE5QUdiWU1ldWYwZG1cbnJldnIxdFpoRk1NaWtIdnJXeGwrS3I0V3RlMVE5anhyR1hGZlFueEd1amFWR0JPTjVGc2MzUEFrcnNtTmMrNG1cbnd0NDZzRE14QW9TVSt2S2pnY0V3Z2I0d0RnWURWUjBQQVFIL0JBUURBZ1dnTUJNR0ExVWRKUVFNTUFvR0NDc0dcbkFRVUZCd01CTUF3R0ExVWRFd0VCL3dRQ01BQXdkQVlEVlIwUkJHMHdhNEpwTHk5aFoyVnVkSE11WVhCcExtMXZcbmJtUnZieTVoY0hBdmMzQmhZMlZ6TDNSbGMzUXRhVzVtWVd4c2FXSnNaUzEwWVhWemMybG5MVGM1TmpVNU5pOXpcblpYSjJhV05sWVdOamIzVnVkSE12TW5Sek9XbFFNSFJPZUZGc1dXdHBRa2xrYVhOT2RtTkRTbGRvTUJNR0ExVWRcbkpnUU1EQXAyWlhKemFXOXVPbll5TUFvR0NDcUdTTTQ5QkFNREEyZ0FNR1VDTVFEd1RRQWlaUW1vTGdWczBhU3RcbjEwYW5UYWQyTFlTSjhsVTRWQlFranIvQTI4cEMxVDdtUUFPQUViUUx1L3BFRjRjQ01DTXk1RVZWN2o1L0VuV2xcbkZ1Rnp3QXVnazBWMHUwZUNoQXBpeG9qWWhMdHFMTXNWTGlYNitLd1A0Q0pXQ3pPcFR3PT1cbi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS1cbiIsImFwaV9lbmRwb2ludCI6Imh0dHA6Ly8xMjcuMC4wLjE6ODk4OSJ9
          bash -c "$(curl -sSL https://install.mondoo.com/sh)"
          cnspec status
          # if [ $(echo $?) != 0 ]; then echo "failed to reach mondoo" exit 1; fi

          cnspec scan
